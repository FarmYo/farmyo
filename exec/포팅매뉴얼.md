
# ğŸ“œ ì£¼ìš” ì¸í”„ë¼ ë° ë²„ì „ ğŸ“œ

![farmyo](/uploads/4e08c02207a2ec9ed547f6dc15495e2e/farmyoì•„í‚¤í…ì²˜.png)
<br>

## ì¸í”„ë¼

1. **OS** 
    - Amazon EC2 Unbuntu 20.04 LTS ( ë©”ëª¨ë¦¬ : 16GB, ë””ìŠ¤í¬ ìš©ëŸ‰ : 320GB )
2. **Storage**
    - Amazon S3 ( Freetier )
3. **Ethereum**
    - Sepolia Testnet
4. **Container**
    - Docker 25.0.4

---
<br>

## Back-End

1. **WAS**
    - java : jdk-17.0.1
    - frameWork : Spring boot 3.2.3
    - orm : Spring Data JPA 3.2.3
    - auth : Spring Security 3.2.3
    - token : jwt 0.12.3
    - blockChain : web3j 4.9.0
2. **DB**
    - MySQL 8.0.36
    - Redis 7.2.4

---
<br>

## Front-End

1. **javascript**
    - node.js alpine-lts
    - react.js 18.2.0
    - react-redux
2. **CSS**
    - DaisyUI 4.7.3
    - TailwindCSS 3.4.1
3. **BlockChain**
    - web3

---
<br>

## CI/CD

1. jenkins 2.440.2

---
<br>

## ê¸°íƒ€

1. **ì´ìŠˆê´€ë¦¬**
    - JIRA
2. **í˜•ìƒê´€ë¦¬**
    - Git (GitLab)
3. **ì»¤ë®¤ë‹ˆì¼€ì´ì…˜**
    - MatterMost, Notion
4. **ë””ìì¸**
    - Figma

---
<br><br>

# ğŸ–‡ ì—°ê²° ğŸ–‡
<br>

## ì‚¬ìš© ì¤‘ì¸ ec2 í¬íŠ¸

1. ssh - `22`
2. nginx `80:80`, `443:443`
3. mysql `3209:3306`
4. WAS `8080:8080`
5. jenkins `9090:8080`
6. redis `6379:6379`

### í¬íŠ¸ ì—´ê¸°

```bash
sudo ufw allow <í¬íŠ¸ë²ˆí˜¸>
```

### í¬íŠ¸ í™•ì¸í•˜ê¸°

```bash
sudo ufw status
```

### ì‚¬ìš©í•˜ëŠ” í¬íŠ¸ ì „ë¶€ ì—´ì–´ì¤€ í›„ ë°©í™”ë²½ í™œì„±í™” í•˜ê¸°

```bash
sudo ufw enable
```
<br>

## SSL ë°œê¸‰

### SSL ì¸ì¦ì„œ ë°œê¸‰í•˜ê¸°

```bash
sudo apt-get install letsencrypt
sudo letsencrypt certonly --standalone -d <ë„ë©”ì¸>
```

ëª…ë ¹ ìˆ˜í–‰ í›„ ë‚˜ì˜¤ëŠ” ì•„ë˜ì™€ ê°™ì€ ë‚´ìš©ì„

ë‹¤ë¥¸ê³³ì— `ctrl + c` + `ctrl + v` í•´ë‘ê¸° (nginx ì„¤ì •ì‹œ ì¸ì¦ì„œì˜ ê²½ë¡œê°€ í•„ìš”í•¨)

```
IMPORTANT NOTES:

- Congratulations! Your certificate and chain have been saved at:
/etc/letsencrypt/live/j10d209.p.ssafy.io/fullchain.pem
Your key file has been saved at:
{ key ê°€ ì €ì¥ë˜ëŠ” ì£¼ì†Œ }
Your cert will expire on 2024-06-09. To obtain a new or tweaked
version of this certificate in the future, simply run certbot
again. To non-interactively renew *all* of your certificates, run
"certbot renew"
- If you like Certbot, please consider supporting our work by:
    
    Donating to ISRG / Let's Encrypt:   https://letsencrypt.org/donate
    Donating to EFF:                    https://eff.org/donate-le
```
<br>

## Docker

### repository ì—…ë°ì´íŠ¸

```bash
sudo apt update
sudo apt upgrade

sudo apt-get update
```

### í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
sudo apt-get install apt-transport-https ca-certificates curl gnupg-agent software-properties-common
```

### Docker ê³µì‹ GPGí‚¤ ì¶”ê°€

```bash
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
```

### Docker ê³µì‹ apt ì €ì¥ì†Œ ì¶”ê°€

```bash
sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
```

### Docker ì„¤ì¹˜

```java
sudo apt-get update
sudo apt install Docker
```

### Docker ì„¤ì¹˜ í™•ì¸

```bash
sudo systemctl status docker
```

Active ì— â€˜active(running)â€™ í™•ì¸
<br>

## MySQL

### MySQL Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ

```bash
docker pull mysql
```

### MySQL docker-compose.db.yml ìƒì„±

```bash
vim docker-compose.db.yml
```

### docker-compose.db.yml ì‘ì„±

environment ì†ì„±ìœ¼ë¡œ ì‚¬ìš©í•  ìŠ¤í‚¤ë§ˆ, root ê³„ì •ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•´ì¤€ë‹¤.

ê·¸ í›„ command ë¥¼ í†µí•´ ì»¨í…Œì´ë„ˆ ë¹Œë“œ ì‹œ ì´ˆê¸°ì— ì„¤ì •ì´ í•„ìš”í•œ ì˜µì…˜ë“¤ì„ ë„£ì–´ì¤€ë‹¤.

```yaml
# mysql
version: "3.1"
services:
  database:
    container_name: mysql-db
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: farmyo
      MYSQL_ROOT_HOST: '%'
      MYSQL_ROOT_PASSWORD: {ì§€ì •í•  ë¹„ë°€ ë²ˆí˜¸}
      TZ: 'Asia/Seoul'
    ports:
      - "3209:3306"
    volumes:
      - {ë¡œì»¬ í™˜ê²½ì—ì„œ conf.d íŒŒì¼ ê²½ë¡œ}:/etc/mysql/conf.d
    command:
      - "mysqld"
      - "--character-set-server=utf8mb4"
      - "--collation-server=utf8mb4_unicode_ci"
      - "--max_connections=500"
```

### ë„ì»¤ ë¹Œë“œ í•˜ê¸°

```bash
docker compose -f docker-compose.db.yml up -d --build
```

### MySQL ì»¨í…Œì´ë„ˆ í™•ì¸í•˜ê¸°

```bash
docker ps -a
```

MySQL ì»¨í…Œì´ë„ˆâ€™mysql-dbâ€™ì´ ì˜¬ë°”ë¥¸ í¬íŠ¸ë¡œ ì—°ê²° ë˜ì—ˆê³  Statusê°€ Upì¸ì§€ í™•ì¸
<br>

## Redis

### Redis Docker ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ

```bash
docker pull redis
```

### Redis docker-compose.redis.yml ìƒì„±

```bash
vim docker-compose.redis.yml
```

### docker-compose.redis.yml ì‘ì„±

redis ì ‘ê·¼ì‹œ í•„ìš”í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì§€ì •í•´ì¤€ë‹¤.

```bash
version: "3.1"
services:
  redis:
    container_name: redis
    image: redis:latest
    restart: unless-stopped
    hostname: redis
    command: >
      --requirepass {redis ì ‘ì†ì— í•„ìš”í•œ ë¹„ë°€ë²ˆí˜¸}
    ports:
      - "6379:6379"
    labels:
      - "name=redis"
      - "mode=standalone"
```

### ë„ì»¤ ë¹Œë“œ í•˜ê¸°

```bash
docker compose -f docker-compose.redis.yml up -d --build
```

### Redis ì»¨í…Œì´ë„ˆ í™•ì¸í•˜ê¸°

```bash
docker ps -a
```

redis ì»¨í…Œì´ë„ˆâ€™redisâ€™ê°€ ì˜¬ë°”ë¥¸ í¬íŠ¸ë¡œ ì—°ê²° ë˜ì—ˆê³  Statusê°€ Upì¸ì§€ í™•ì¸
<br>

## Nginx

### Front - Dockerfile ì‘ì„±

```bash
FROM node:lts-alpine as build-stage
WORKDIR /homepage
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM nginx:stable-alpine as production-stage
COPY --from=build-stage ./homepage/build /usr/share/nginx/html/
CMD ["nginx", "-g", "daemon off;"]
```

nodeëŠ” lts-alpine ë²„ì „ì„ ì‚¬ìš©í•˜ê³  node-modulesë¥¼ ì„¤ì¹˜í•œ í›„ ë¹Œë“œë¥¼ í•´ì¤ë‹ˆë‹¤.

ë„ì»¤ íŒŒì¼ì„ /frontend/farmyo ë‚´ë¶€ì— ë„£ì–´ì„œ í•´ë‹¹ ë””ë ‰í† ë¦¬ì—ì„œ ë¹Œë“œí•  ìˆ˜ ìˆê²Œ í•©ë‹ˆë‹¤.

### Back - Dockerfile ì‘ì„±

```bash
FROM openjdk:17-jdk-alpine

WORKDIR /app

ARG JAR_FILE=build/libs/farmyo-0.0.1-SNAPSHOT.jar

COPY ${JAR_FILE} test.jar

ENTRYPOINT ["java", "-jar","test.jar","--encryptor.key=${JASYPT_KEY}"]
```

javaëŠ” jdk-17-alpineì„ ì‚¬ìš©í•˜ì—¬ jarë¥¼ ë¹Œë“œí•˜ê³  ì‹¤í–‰í•´ì¤ë‹ˆë‹¤.

JASYPTë¡œ ì•”í˜¸í™”í•˜ê³  ìˆê¸° ë•Œë¬¸ì— í™˜ê²½ë³€ìˆ˜ ì˜µì…˜ìœ¼ë¡œ JASYPT_KEY ê°’ì„ ì¤ë‹ˆë‹¤.

ìœ„ ë„ì»¤ íŒŒì¼ ë˜í•œ /backend/farmyo ë‚´ë¶€ì— ë„£ì–´ì„œ ë¹Œë“œí•  ìˆ˜ ìˆê²Œ í•´ì¤ë‹ˆë‹¤.

### Front + Back í†µí•© ë¹Œë“œìš© docker-compose.yml ì‘ì„±

```bash
version: '3.8'                      
services:                           
  farmyo-frontend:                         
    container_name: farmyo-frontend      
    build:                          
      context: ./frontend/farmyo          
      dockerfile: Dockerfile        
    ports:                          
      - "80:80"                     
      - "443:443"
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt
      - /var/lib/letsencrypt:/var/lib/letsencrypt
      - /home/ubuntu/conf:/etc/nginx/conf.d
    networks:
      - farmyo_network

  farmyo-backend:
    container_name: farmyo-backend
    build:
      context: ./backend/farmyo
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:                    
      JASYPT_KEY: {ì•”í˜¸í™” ëœ JASYPT_KEY}
    networks:
      - farmyo_network

networks:
  farmyo_network:
    driver: bridge
```
<br>

## Jenkins

### Docker Jenkins ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ

```bash
docker pull jenkins/jenkins:jdk17
```

### Jenkins docker-compose.jenkins.yml ì‘ì„±

```bash
version: "3.1"
services:
  jenkins:
    image: jenkins/jenkins:jdk17
    restart: unless-stopped
    user: root
    ports:
      - 9090:8080
    volumes:
      - /home/ubuntu/jenkins:/var/jenkins_home
      - /home/ubuntu/.ssh:/root/.ssh
      - /var/run/docker.sock:/var/run/docker.sock
```

### Jenkins ì»¨í…Œì´ë„ˆ ë¹Œë“œ

```bash
docker compose -f docker-compose.jenkins.yml up -d --build
```

### Jenkins ì»¨í…Œì´ë„ˆë¡œ ì ‘ì†

```bash
docker exec -it jenkins bash
```

### Jenkins ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ë„ì»¤ í™˜ê²½ êµ¬ì„±

```bash
apt-get update && \
apt-get -y install apt-transport-https \
     ca-certificates \
     curl \
     gnupg2 \
     software-properties-common && \
curl -fsSL https://download.docker.com/linux/$(. /etc/os-release; echo "$ID")/gpg > /tmp/dkey; apt-key add /tmp/dkey && \
add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/$(. /etc/os-release; echo "$ID") \
   $(lsb_release -cs) \
   stable" && \
apt-get update && \
apt-get -y install docker-ce
```

### ì ‘ê·¼ ê¶Œí•œ ì„¤ì •

```bash
groupadd -f docker

usermod -aG docker jenkins

chown root:docker /var/run/docker.sock
```
<br><br>

# ë¹Œë“œ ë° ë°°í¬
<br>

## Jenkins

### GitLab

GitLabì— ì½”ë“œë¥¼ Pushí•´ì„œ web-hookì„ ë‚ ë ¸ì„ ë•Œ

jenkinsê°€ ê°ì§€í•˜ë©´ ë¹Œë“œí•  ìˆ˜ ìˆë„ë¡ í™˜ê²½ ì„¤ì • í•„ìš”

### MatterMost

jenkins ë¹Œë“œ í›„ ë°°í¬ ì™„ë£Œ ë˜ë©´

MatterMostì— ì—°ê²°ëœ ì±„ë„ì— ë°°í¬ ì•Œë¦¼ì„ ë°œì†¡í•˜ë„ë¡ ì„¤ì • ê°€ëŠ¥

### jenkins pipe-line ì‘ì„±

```bash
pipeline {
    agent any
    
    stages {
        stage('Clone') {
            steps{
                git branch: '{ë³€ê²½ ê°ì§€ í•  ë¸Œëœì¹˜}', credentialsId: '{credential ì•„ì´ë””}', url: '{web-hook ë³´ë‚´ëŠ” git ë¦¬í¬ì§€í† ë¦¬ ì£¼ì†Œ ex) ~~.git}'           
                sh "sed -i 's/{docker-compose.ymlì—ì„œ ì•”í˜¸í™”ëœ JASYPT_KEY}/{ì•”í˜¸í™” ì „ í‚¤}/g' docker-compose.yml"
                sh "cat docker-compose.yml"
            }
            
        }
        stage('Build'){
            steps{
                dir('backend/farmyo') {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean build"
                }
            }
            
        }
        stage('Deploy') {
            steps{
                // ì´ì „ì— ì‹¤í–‰ëœ ì»¨í…Œì´ë„ˆë¥¼ ì¤‘ì§€í•˜ê³  ì‚­ì œí•©ë‹ˆë‹¤.
                sh "docker stop farmyo-backend || true"
                sh "docker rm farmyo-backend || true"
            
                sh "docker stop farmyo-frontend || true"
                sh "docker rm farmyo-frontend || true"
            
                // ì´ì „ì— ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.
                sh "docker rmi farmyo_pipeline-farmyo-frontend || true"
                sh "docker rmi farmyo_pipeline-farmyo-backend || true"
                
                sh "docker ps -a || true"
                sh "docker images || true"
                
                sh "docker compose build --no-cache"
                sh "docker compose up -d"
            }
        }
    }
    post {
        success {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'good', 
                message: "ë¹Œë“œ ì„±ê³µ ^_^ v : ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)", 
                endpoint: '{deploy ì•Œë¦¼ì„ ë°›ì„ Mattermost ì±„ë„ ì£¼ì†Œ}', 
                channel: '{ì•Œë¦¼ ë°›ì„ ì±„ë„ ëª…}'
                )
            }
        }
        failure {
        	script {
                def Author_ID = sh(script: "git show -s --pretty=%an", returnStdout: true).trim()
                def Author_Name = sh(script: "git show -s --pretty=%ae", returnStdout: true).trim()
                mattermostSend (color: 'danger', 
                message: "ë¹Œë“œ ì‹¤íŒ¨ ã…œ_ã…œ : ${env.JOB_NAME} #${env.BUILD_NUMBER} by ${Author_ID}(${Author_Name})\n(<${env.BUILD_URL}|Details>)", 
                endpoint: '{deploy ì•Œë¦¼ì„ ë°›ì„ Mattermost ì±„ë„ ì£¼ì†Œ}', 
                channel: '{ì•Œë¦¼ ë°›ì„ ì±„ë„ ëª…}'
                )
            }
        }
    }
}
```
